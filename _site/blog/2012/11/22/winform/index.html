
<!DOCTYPE html>
<html lang="ZH-CN">
  <head>
    <meta charset="utf-8">
    <title>WinForm常用功能备忘</title>
    <meta name="description" content="记录在开发时对于WinForm的一些基本类库或控件备忘">
    <meta name="author" content="NanQi">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/prettify.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/docs.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/">南琦的博客</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              
              
              


  
    
      
      	
      	<li>
            <a href="/archive.html">
                归档
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/categories.html">
                分类
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/questions.html">
                问题
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/tags.html">
                标签
                
            </a>
        </li>
      	
      
    
  



            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="content">
        
<?xml version="1.0" encoding="utf-8"?>
<div class="page-header">
  <h1>WinForm常用功能备忘
    <small>
      
      
    </small>
  </h1>
</div>

<div class="row-fluid">
  <div class="span9">
    <div id="divPost">
      
      <h2>更新历史：</h2>

<hr />

<ul>
<li>2012-11-22 &raquo; 创建文章，<a href="#DataGridView">DataGridView</a>，<a href="#DataGridViewStyle">调整单元格样式后排序...</a></li>
<li>2012-12-10 &raquo; 增加<a href="#ListView">ListView</a>，<a href="#ListViewSort">关于ListView排序的众多问题</a></li>
</ul>


<p><section id="DataGridView" /></p>

<h2>DataGridView</h2>

<hr />

<p>在WinForm中，DataGridView是常用列表显示控件，也是相对复杂的一个控件，对于经常做管理软件的开发者，DataGridView也是打交道最多的一个。
这里记录本人在实际开发中使用DataGridView的一些备忘。</p>

<p><section id="DataGridViewStyle" /></p>

<h3>调整单元格样式后排序或其他方式使控件刷新而丢失样式的问题</h3>

<hr />

<p>很多软件都有这么一个需求：对于异常数据或特殊数据进行高亮显示。<br/>
如一个超限软件，对于超限率不同的检测车辆进行不同的颜色显示；又如某设备管理软件，对于即将维保、年检的设备进行黄色提示，对于已过维保期的设备进行红色提示等等。<br/>
本人在做的时候，都是在绑定数据后，循环遍历一次数据，判断某列的值是否符合某种标准，否则给予标注。</p>

<p>以前做法：</p>

<pre><code>void BindData()
{
    //BindData...

    for(int i = 0; i &lt; dataGridView1.Rows.Length; i++)
    {
        if(dataGridView.Rows[i].Cells["停用标识"].Value.ToString() == "启用")
        {
            dataGridView.Rows[i].Cells["停用标识"].Style.BackColor = Color.Red;
        }
    }
}
</code></pre>

<p>但随后发现如果点击排序，都会丢失之前设置的样式。
对于这种不是很影响功能的问题，当初我都不怎么在意，或者对于不是很需要排序功能的直接禁止其排序。（这种思想是不是很不好……）</p>

<p>但问题终归是问题，最后还是得解决。
注册CellFormatting事件，在其中进行判断。</p>

<p>代码如下：</p>

<pre><code>void dataGridView1_CellFormatting(object sender, 
    DataGridViewCellFormattingEventArgs e)
{
    if(e.ColumnIndex = 7 &amp;&amp; e.Value.ToString() == "启用")
    {
        e.CellStyle.BackColor = Color.Red;
    }
}
</code></pre>

<p><section id="ListView" /></p>

<h2>ListView</h2>

<hr />

<p>相较DataGridView而言，ListView在WinForm开发中比较灵活，列表可以实现，带图标的排列也没问题，而且做一些效果也是不错。ListView显然没有DataGirdView封装的那么"严实"，也正是因为这个问题，很多看似简单的功能在ListView中实现很难。</p>

<p><section id="ListViewSort" /></p>

<h3>关于ListView排序的众多问题</h3>

<hr />

<p>最近需要在软件中增加FTP功能，说是简单的功能，但是做起来也遇到了不少问题。主要问题就是目录浏览的问题，如何从FTP返回的列表中分割出大小、修改时间等也是当初没有想到的。而在列表展示上使用ListView控件的主要原因就是ListView控件"添加"数据比较自然，而DataGridView更多的是"绑定"数据。<br/>
随后发现ListView没有排序功能。<br/>
其实排序功能还是有的，只不过需要自己给定一个比较器。</p>

<pre><code>listView1.ListViewItemSorter = XXXComparer.Instance(XXXComparer : IComparer)
</code></pre>

<p><img src="/image/winform/ListViewSort.png" alt="ListViewSort" /></p>

<p>这就是我FTP的窗口。只显示了文件名、大小和修改时间，文件名中目录使用<code>[目录名]</code>的方式展示，文件名的排序方式按道理上来讲应该是向上、目录、文件这种顺序。大小和修改时间就不用多说了。<br/>
这时候，问题就出来了：ListView的项（<code>SubItem</code>）没有数据类型一说。<br/>
对此，给我ListViewSubItem增加了一个强类型的ListViewSubItem：</p>

<pre><code>/// &lt;summary&gt;
/// 强类型ListViewSubItem
/// &lt;/summary&gt;
/// &lt;typeparam name="T"&gt;&lt;/typeparam&gt;
public class ListViewTypeSubItem&lt;T&gt; : ListViewItem.ListViewSubItem
{
    public ListViewTypeSubItem()
    {
        ValueType = typeof(T);
    }

    public Type ValueType { get; set; }

    public T Value { get; set; }
}
</code></pre>

<p>当然，这个所谓的强类型还是有一定的问题。暂时这么着吧。<br/>
有了强类型的 ListViewSubItem 那么给ListView赋值就要有相应的修改。</p>

<pre><code>foreach (var file in files)
{
    lvi = new ListViewItem(file.IsDirectory ? string.Format("[{0}]", file.Name) : file.Name);

    size = new ListViewTypeSubItem&lt;long&gt;();
    size.Text = file.Size.ToString("N0");
    size.Value = file.Size;
    lvi.SubItems.Add(size);

    date = new ListViewTypeSubItem&lt;DateTime&gt;();
    date.Text = file.CreateTime.ToString("yyyy-MM-dd HH:mm");
    date.Value = file.CreateTime;
    lvi.SubItems.Add(date);

    lvi.Tag = file.IsDirectory ? FileTypeEnum.Directory : FileTypeEnum.File;

    lvFtpFile.Items.Add(lvi);
}
</code></pre>

<p>当然，重要的比较器还没有写。这里列出我写的比较器，其中应该有点问题，因为当初没有想让他能点两次。也就是说没有想让他支持点一次是<code>asc</code>，再点一次就是<code>desc</code>。本来只是想做个排序，让大小和修改时间逆序排，而文件名就按我上面说的规则排列。最后需求有所变动。<br/>
说了半天，列出我的比较器：</p>

<pre><code>/// &lt;summary&gt;
/// ListViewItem自定义排序
/// 对long类型和DateTime类型进行处理(DESC)
/// 对于字符串,目录排在文件上面,向上排在最上边
/// &lt;/summary&gt;
public class ListViewItemComparer : IComparer
{
    private static int col;
    private static bool isDesc = false;

    public ListViewItemComparer(int column)
    {
        col = column;
    }

    public int Compare(object x, object y)
    {
        int result = 0;
        var sub = ((ListViewItem)x).SubItems[col];
        if (sub is ListViewTypeSubItem&lt;long&gt;)
        {
            var sub_x = ((ListViewItem)x).SubItems[col] as ListViewTypeSubItem&lt;long&gt;;
            var sub_y = ((ListViewItem)y).SubItems[col] as ListViewTypeSubItem&lt;long&gt;;
            if (sub_x.Value &gt; sub_y.Value)
            {
                result = 1;
            }
            else if (sub_x.Value == sub_y.Value)
            {
                result = 0;
            }
            else
            {
                result = -1;
            }
        }
        else if (sub is ListViewTypeSubItem&lt;DateTime&gt;)
        {
            var sub_x = ((ListViewItem)x).SubItems[col] as ListViewTypeSubItem&lt;DateTime&gt;;
            var sub_y = ((ListViewItem)y).SubItems[col] as ListViewTypeSubItem&lt;DateTime&gt;;

            result = DateTime.Compare(sub_y.Value, sub_x.Value);
        }
        else
        {
            string sub_x = ((ListViewItem)x).SubItems[col].Text;
            string sub_y = ((ListViewItem)y).SubItems[col].Text;
            if ((sub_x[0] == '[' &amp;&amp; sub_x[sub_x.Length - 1] == ']') &amp;&amp;
            (sub_y[0] != '[' || sub_y[sub_y.Length - 1] != ']'))
            {
                return -1;
            }
            else
            {
                result = string.Compare(sub_x, sub_y);
            }
        }

        var lvi_x = (ListViewItem)x;
        var lvi_y = (ListViewItem)y;

        if (lvi_x.Text == "[..]")
        {
            return -1;
        }

        //if (lvi_y.Text == "[..]")
        //{
        //   return isDesc ? 1 : -1;
        //}

        return isDesc ? result : result == 0 ? 0 : result == 1 ? -1 : 1;
    }

    public static ListViewItemComparer Sort(int column = 0)
    {
        isDesc = !isDesc;

        return new ListViewItemComparer(column);
    }
}
</code></pre>

<p>应该从代码中更能感觉到曾经改过的样子。<br/>
自我感觉上面的<code>return isDesc ? result : result == 0 ? 0 : result == 1 ? -1 : 1;</code>一定会有人说。哈哈。</p>

    </div>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2012/11/22/dockpanel" title="WeifenLuo的DockPanel备忘">&larr; 上一页</a></li>
      
        <li><a href="/archive.html">列表</a></li>
      
        <li class="next"><a href="/blog/2012/11/25/html" title="html备忘">下一页 &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'nanqi'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  <div class="span3">
    <h4>Published</h4>
    <div class="date">
      <span>2012-11-22</span>
    </div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#C#-ref">C# <span>10</span></a></li>
     
    	<li><a href="/tags.html#WinForm-ref">WinForm <span>4</span></a></li>
    
  



    </ul>
  
  </div>
</div>


      </div>

      <footer>
        <p>&copy; NanQi 2012 - 2013
          参考 <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          和 <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          源码托管在 <a href="https://github.com/nanqi">NanQi Github</a> 版权声明 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">CC BY-NC-SA 3.0</a>
          <script src="http://s95.cnzz.com/stat.php?id=4758074&web_id=4758074" language="JavaScript"></script>
        </p>
      </footer>

    <script src="/assets/themes/twitter/js/jquery.js"></script>
    <script src="/assets/themes/twitter/js/prettify.js"></script>
    <script src="/assets/themes/twitter/js/holder.js"></script>
    <script src="/assets/themes/twitter/bootstrap/js/bootstrap.min.js"></script>
    </div> <!-- /container -->

    <script type="text/javascript">
        $(window).load(function () {
                $("pre").addClass("prettyprint linenums");
                prettyPrint();
        })
    </script>

    
  </body>
</html>

