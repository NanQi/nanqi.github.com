
<!DOCTYPE html>
<html lang="ZH-CN">
  <head>
    <meta charset="utf-8">
    <title>WPF控件开发(2)</title>
    <meta name="description" content="使用WPF实现自动完成功能，以百度首页为例，做了一个简单的dem">
    <meta name="author" content="NanQi">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Le HTML5 shim, for IE6-8 support of HTML elements -->
    <!--[if lt IE 9]>
      <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->

    <!-- Le styles -->
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <link href="/assets/themes/twitter/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/prettify.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/assets/themes/twitter/css/docs.css?body=1" rel="stylesheet" type="text/css" media="all">
    <link href="/css/style.css?body=1" rel="stylesheet" type="text/css" media="all">
    <!-- Le fav and touch icons -->
  <!-- Update these with your own images
    <link rel="shortcut icon" href="images/favicon.ico">
    <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
  -->
  </head>

  <body>
    <div class="navbar navbar-inverse navbar-fixed-top">
      <div class="navbar-inner">
        <div class="container">
          <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="brand" href="/">南琦的博客</a>
          <div class="nav-collapse collapse">
            <ul class="nav">
              
              
              


  
    
      
      	
      	<li>
            <a href="/archive.html">
                归档
                
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/categories.html">
                分类
                
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/MyProgram.html">
                我的软件
                
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/Questions.html">
                问题
                
                
            </a>
        </li>
      	
      
    
  
    
      
    
  
    
      
      	
      	<li>
            <a href="/tags.html">
                标签
                
                
            </a>
        </li>
      	
      
    
  



            </ul>
          </div>
        </div>
      </div>
    </div>
    <div class="container">
      <div class="content">
        
<?xml version="1.0" encoding="utf-8"?>
<div class="page-header">
  <h1>WPF控件开发(2)
    <small>
      
      
          自动完成(AutoComplete)-1
      
    </small>
  </h1>
</div>

<div class="row-fluid">
  <div class="span9">
    <div id="divPost">
      
      <p>自动完成功能使用范围很广，多以TextBox或ComboBox的形式出现，在输入的同时给予候选词，候选词一般有两种方式获取。</p>

<ul>
<li>一种类似Baidu，Google，Bing之类的搜索引擎所用的直接给予前十个候选词，或者VS等IDE的自动完成，这种多以文本输入为准，候选词只作为·候选·所用；</li>
<li>较之第一种，管理类软件中可能会以筛选的形式出现。与第一种不同之处，就是这里可能注重的是选择一条数据，输入的文本只是用来·筛选·。</li>
</ul>


<p>由此可看出，自动完成功能，就是为了提高用户体验，如果稍稍留心，会发现我们使用操作系统，软件，浏览器的时候，有各式各样的自动完成功能。</p>

<h2>百度首页</h2>

<hr />

<p>我本想只做一个简单的例子，不涉及界面部分，但是一时兴起，做了一个山寨版的百度首页，界面费了不少时间。</p>

<p><img src="/image/wpf/baidu.png" alt="百度首页" /></p>

<p>由于这里使用的是TextBox，所以重写了TextBox的模板，给里面放了一个Popup一个ListBox，然后对一些键盘鼠标事件进行操作，基本不难理解，至于Suggestion服务，就是解析json对象的问题，这里用现成的东西。</p>

<pre><code>public string[] GetItems(string textPattern)
{
    string _uriFormat = @"http://suggestion.baidu.com/su?wd={0}";
    WebRequest request = null;
    WebResponse response = null;
    try
    {
        var uri = new Uri(string.Format(_uriFormat, HttpUtility.UrlEncode(textPattern)));
        request = WebRequest.Create(uri);
        try
        {
            response = request.GetResponse();
        }
        catch
        {
            return null;
        }
        object[] jsonResult;
        using (var stream = response.GetResponseStream())
        {
            var reader = new StreamReader(stream, Encoding.Default);
            var json = reader.ReadToEnd();
            Regex rege = new Regex(@"s:(\[.*\])");
            var mat = rege.Match(json).Groups[1];
            jsonResult = _jsonSerializer.DeserializeObject(mat.Value) as object[];
        }

        return jsonResult.Cast&lt;string&gt;().ToArray();
    }
    finally
    {
        if (response != null)
        {
            response.Close();
        }
        if (request != null)
        {
            request.Abort();
        }
    }
}
</code></pre>

<p><img src="/image/wpf/suggestion.png" alt="Suggestion" /></p>

<h2>输入缓冲</h2>

<hr />

<p>关于输入缓冲，早在做ComboBox的时候就需要。<br/>
所谓输入缓冲，在这里的意思就是不在每次文本改变的时候去根据输入查询，而是有一定的缓冲，因为可能我需要的是12306，而不是123的结果。</p>

<p>当然，实现方式也有很多，这里我只是使用了Timer实现。</p>

<pre><code>_interval.Elapsed += (s1, e1) =&gt;
{
    _interval.Stop();
    _isKeyEvent = false;

    string input = string.Empty;
    txtSearch.Dispatcher.Invoke(new Action(() =&gt; input = txtSearch.Text));
    var lst = GetItems(input);
    _listSuggestion.Dispatcher.Invoke(new Action(() =&gt; _listSuggestion.ItemsSource = lst));
    _popupSuggestion.Dispatcher.Invoke(new Action(() =&gt; _popupSuggestion.IsOpen = lst.Length &gt; 0));
};
</code></pre>

<p>其实就是将原本在TextChanged事件处理函数里的代码挪到Elapsed事件里面来，TextChanged里面只需要判断是否是键盘输入，是的话就让他重置一次：</p>

<pre><code>if (_isKeyEvent)
{
    _interval.Stop();
    _interval.Start();
}
</code></pre>

<h2>所遇问题</h2>

<hr />

<p>我曾经在一篇<a href="/blog/2013/03/29/winform-wpf-2/">介绍ComboBox的博客</a>中说了使用ComboBox做自动完成功能时遇到的问题，这次与ComboBox自是不相同，但是也遇到不少问题。</p>

<ol>
<li>Popup，ListBox与TextBox操作出现的问题</li>
<li>Popup展开时切换窗口</li>
<li>鼠标选择ListBox某一条</li>
<li>逻辑焦点在ListBox，输入焦点在TextBox上</li>
</ol>


<p>其实与其把这些说成WPF的问题，不如说是WPF灵活的一种表现，所幸这些常见的问题都有相应的解决方案。</p>

<p>看源码学习确实很好，但是往往源码过于复杂，根本无从看起，这时候就应该以最小功能去实现，然后碰到问题看他人是如何解决。<br/>
其实软件发展到今天，很多东西早有人已经实现，认认真真看完一篇宏伟的工程，有时比自己一个劲的瞎琢磨要好的多。</p>

      

    </div>
    <hr>
    <div class="pagination">
      <ul>
      
        <li class="prev"><a href="/blog/2013/06/02/wpf-control-placeholder" title="WPF控件开发(1)">&larr; 上一页</a></li>
      
        <li><a href="/archive.html">列表</a></li>
      
        <li class="next"><a href="/blog/2013/06/25/introspection" title="工作2年，反省与总结">下一页 &rarr;</a></li>
      
      </ul>
    </div>
    <hr>
    


  <div id="disqus_thread"></div>
<script type="text/javascript">
    var disqus_developer = 1;
    var disqus_shortname = 'nanqi'; // required: replace example with your forum shortname
    
    /* * * DON'T EDIT BELOW THIS LINE * * */
    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">blog comments powered by <span class="logo-disqus">Disqus</span></a>




  </div>
  <div class="span3">
    <h4>Published</h4>
    <div class="date">
      <span>2013-06-16</span>
    </div>

  
    <h4>Tags</h4>
    <ul class="tag_box">
    
    


  
     
    	<li><a href="/tags.html#C#-ref">C# <span>15</span></a></li>
     
    	<li><a href="/tags.html#WPF-ref">WPF <span>5</span></a></li>
    
  



    </ul>
  
  </div>
</div>


      </div>

      <footer>
        <p>&copy; NanQi 2012 - 2013
          参考 <a href="http://jekyllbootstrap.com" target="_blank" title="The Definitive Jekyll Blogging Framework">Jekyll Bootstrap</a>
          和 <a href="http://twitter.github.com/bootstrap/" target="_blank">Twitter Bootstrap</a>
          源码托管在 <a href="https://github.com/nanqi">NanQi Github</a> 版权声明 <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">CC BY-NC-SA 3.0</a>
          <script src="http://s95.cnzz.com/stat.php?id=4758074&web_id=4758074" language="JavaScript"></script>
        </p>
      </footer>

    <script src="/assets/themes/twitter/js/jquery.js"></script>
    <script src="/assets/themes/twitter/js/prettify.js"></script>
    <script src="/assets/themes/twitter/js/holder.js"></script>
    <script src="/assets/themes/twitter/bootstrap/js/bootstrap.min.js"></script>
    </div> <!-- /container -->

    <script type="text/javascript">
        $(window).load(function () {
                $("pre").addClass("prettyprint linenums");
                prettyPrint();
        })
    </script>

    
  </body>
</html>

